<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Asistencia - PROEDSO</title>

  <style>
    * {
      box-sizing: border-box;
      font-family: "Segoe UI", system-ui, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #0d6efd, #0b5ed7);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 15px;
    }

    .card {
      background: #fff;
      width: 100%;
      max-width: 380px;
      border-radius: 18px;
      padding: 25px 22px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, .25);
      text-align: center;
      animation: fadeIn .4s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h2 {
      margin-top: 0;
      margin-bottom: 8px;
      font-size: 22px;
    }

    p.subtitle {
      font-size: 14px;
      color: #555;
      margin-bottom: 20px;
    }

    input {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      outline: none;
      margin-bottom: 15px;
    }

    input:focus {
      border-color: #0d6efd;
    }

    button {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      background: #0d6efd;
      color: white;
      transition: background .2s, transform .1s;
    }

    button:active {
      transform: scale(0.98);
    }

    button:disabled {
      background: #9bbcff;
      cursor: not-allowed;
    }

    #msg {
      margin-top: 18px;
      font-size: 15px;
      min-height: 20px;
    }

    .ok {
      color: #198754;
    }

    .warn {
      color: #f59f00;
    }

    .err {
      color: #dc3545;
    }

    .info {
      color: #0d6efd;
    }

    footer {
      margin-top: 18px;
      font-size: 12px;
      color: #888;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>üìã Registro de Asistencia</h2>
    <p class="subtitle">PROEDSO - Marca tu asistencia</p>

    <input type="text" id="nombre" placeholder="üë§ Ingresa tu nombre completo">
    <button id="btn" onclick="marcar()">üìç Marcar asistencia</button>
    <div id="msg"></div>
    <footer>Activa tu GPS para continuar</footer>
  </div>

  <script>
    const URL_BACKEND = "https://script.google.com/macros/s/AKfycbxSdPNKfZy-L0w9nOMYLWOKy6dmrZYnFJxegvgguO_9_ZjpbsZeAQP1aYjux6s2xdDU/exec";

    // Horarios colaboradores (sin acentos)
    const horarios = {
      "fabricio daniel pacheco calderon": [{ inicio: "09:00", fin: "12:30" }, { inicio: "15:00", fin: "19:00" }],
      "ivan maicol gonzales rodriguez": [{ inicio: "14:00", fin: "19:00" }],
      "abigail joyce nique marquina": [{ inicio: "08:30", fin: "13:30" }],
      "ivana becerra ortigas": [{ inicio: "09:00", fin: "13:00" }, { inicio: "15:00", fin: "19:00" }],
      "cesar agusto galvez ascoy": [{ inicio: "09:00", fin: "13:00" }]
    };

    // Normaliza texto: min√∫sculas, sin acentos, trim
    function normalizar(texto) {
      return texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").trim();
    }

    // Convierte HH:MM a Date
    function crearHora(hora, minuto) {
      const d = new Date();
      d.setHours(hora, minuto, 0, 0);
      return d;
    }

    function buscarNombre(nombre) {
      const n = normalizar(nombre).split(" "); // palabras del input
      for (const clave in horarios) {
        const clavePalabras = clave.split(" ");
        // buscar al menos 1 palabra coincidente
        if (n.some(palabra => clavePalabras.includes(palabra))) {
          return horarios[clave];
        }
      }
      return null;
    }



    // Validaci√≥n horario 30min antes y 5min despu√©s
    function validarHorario(nombre) {
      const ahora = new Date();
      const turnos = buscarNombre(nombre);
      if (!turnos) return { ok: false, msg: "‚ùå No est√°s registrado en el sistema" };

      for (let t of turnos) {
        const [hIni, mIni] = t.inicio.split(":").map(Number);
        const inicio = crearHora(hIni, mIni - 30);
        const fin = crearHora(hIni, mIni + 5);
        if (ahora >= inicio && ahora <= fin) return { ok: true };
      }

      return { ok: false, msg: "‚è∞ Solo puedes marcar entre 30 min antes y 5 min despu√©s del inicio del turno" };
    }

    function marcar() {
      const nombreInput = document.getElementById("nombre");
      const nombre = nombreInput.value.trim();
      const msg = document.getElementById("msg");
      const btn = document.getElementById("btn");

      msg.className = "";
      if (!nombre) {
        msg.textContent = "‚ö†Ô∏è Ingresa tu nombre";
        msg.classList.add("warn");
        return;
      }

      const validacion = validarHorario(nombre);
      if (!validacion.ok) {
        msg.textContent = validacion.msg;
        msg.classList.add("err");
        return;
      }

      // Calculamos el estado seg√∫n el turno
      const ahora = new Date();
      const turnos = buscarNombre(nombre);
      let estado = "SIN TURNO";

      for (let t of turnos) {
        const [hIni, mIni] = t.inicio.split(":").map(Number);
        const inicio = crearHora(hIni, mIni - 30);
        const fin = crearHora(hIni, mIni + 5);
        if (ahora >= inicio && ahora <= fin) {
          estado = "PUNTUAL";
          break;
        } else if (ahora > fin) {
          estado = "TARDE";
        }
      }

      btn.disabled = true;
      msg.textContent = "üì° Obteniendo ubicaci√≥n...";
      msg.classList.add("info");

      navigator.geolocation.getCurrentPosition(
        pos => {
          fetch(URL_BACKEND, {
            method: "POST",
            body: JSON.stringify({
              nombre: nombre,
              lat: pos.coords.latitude,
              lon: pos.coords.longitude,
              estado // <-- enviamos estado calculado
            })
          })
            .then(r => r.json())
            .then(res => {
              msg.className = "";
              btn.disabled = false;

              if (res.permitido) {
                msg.textContent = `‚úÖ Asistencia registrada (${res.distancia || "N/A"} m)`;
                msg.classList.add("ok");
              } else if (res.motivo === "DUPLICADO") {
                msg.textContent = "‚ö†Ô∏è Ya marcaste asistencia hoy";
                msg.classList.add("warn");
              } else {
                msg.textContent = `‚ùå Fuera del local (${res.distancia || "N/A"} m)`;
                msg.classList.add("err");
              }
            })
            .catch(() => {
              btn.disabled = false;
              msg.textContent = "‚ùå Error al enviar datos";
              msg.classList.add("err");
            });
        },
        () => {
          btn.disabled = false;
          msg.textContent = "‚ùå Activa el GPS y acepta permisos";
          msg.classList.add("err");
        },
        { enableHighAccuracy: true }
      );
    }

  </script>
</body>

</html>
